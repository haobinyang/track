{"version":3,"sources":["common/types/asset.ts","asset/images.ts","common/types/clip.ts","common/components/Draggable/config.ts","asset/index.ts","asset/videos.ts","common/utils/index.ts","common/components/Draggable/index.tsx","editor/config.ts","editor/util.ts","editor/components/AssetCard/components/ImageCard/styled.tsx","editor/components/AssetCard/components/ImageCard/index.tsx","editor/components/AssetCard/components/VideoCard/styled.tsx","editor/components/AssetCard/components/VideoCard/index.tsx","editor/components/AssetCard/styled.tsx","editor/components/AssetCard/index.tsx","common/types/player.ts","editor/components/Stage/index.tsx","editor/components/SideBar/index.tsx","editor/components/Tracks/components/TrackElement/styled.tsx","editor/components/Tracks/components/TrackElement/index.tsx","editor/components/Tracks/components/Track/styled.tsx","editor/components/Tracks/components/Track/index.tsx","editor/components/Tracks/styled.tsx","editor/components/Tracks/index.tsx","editor/styled.tsx","editor/components/Ruler/styled.tsx","editor/components/Ruler/index.tsx","editor/hooks/index.ts","editor/hooks/keyboard.ts","player/clips/base.ts","player/painter/shader.ts","player/effects/index.ts","player/effects/noEffect.ts","player/effects/gray.ts","player/clips/video.ts","player/clips/image.ts","player/clips/text.ts","player/clips/audio.ts","player/transitions/index.ts","player/transitions/morph.ts","player/transitions/dreamy.ts","player/transitions/fade.ts","player/clips/transition.ts","player/clips/svg.ts","player/painter/index.ts","player/clips/lottie.ts","player/index.ts","editor/index.tsx","editor/hooks/player.ts","index.tsx","../external \"THREE\""],"names":["AssetType","ClipType","MoveDirection","ASSET","videos","name","url","map","video","type","VIDEO","images","image","IMAGE","audios","secondsToTimeFormat","seconds","date","Date","setSeconds","toISOString","substr","svgToCanvas","svg","canvas","canvasContext","Promise","resolve","width","height","Image","onload","clearRect","drawImage","src","trim","watch","watchObj","key","callback","currentVal","Object","defineProperty","get","set","newVal","oldVal","Draggable","children","direction","ALL","scrollContainerSelector","autoGrow","enable","attachData","slow","onMove","onEnd","childRef","useRef","shiftX","shiftY","timer","originalStyle","originalLeft","originalTop","preLeft","preTop","isEnd","count","isHoverScrollContainer","useState","dragInfo","setDragInfo","useEffect","current","undefined","move","useCallback","el","pageX","pageY","transformStyle","EW","NS","style","transform","handleHold","step","wrapper","scrollContainer","window","setInterval","wrapperRect","getBoundingClientRect","scrollLeft","clientWidth","handleScroll","below","clearInterval","scrollThreshold","document","querySelector","closest","parentElement","right","Math","min","left","handleMouseMove","e","hidden","elementFromPoint","clientX","clientY","currentLeft","currentTop","element","belowElement","top","stepLeft","stepTop","cursorLeft","cursorTop","handleMouseUp","classList","remove","setAttribute","removeEventListener","handleMouseDown","stopPropagation","getAttribute","styles","keys","forEach","setProperty","replace","toLowerCase","setStyles","add","addEventListener","container","React","cloneElement","ref","TRACK_WRAPPER_CLASS_NAME","SECOND_WIDTH","INIT_EDITOR_CONTEXT","hoverTrack","setHoverTrack","tracks","setTracks","newTrackIndex","setNewTrackIndex","activeClipId","setActiveClipId","currentTime","setCurrentTime","totalDuration","setTotalDuration","trackWrapperSelector","cursorPositionToElementPosition","cursorPosition","rect","x","max","y","cursorPositionToTracksWrapperPosition","tracksWrapper","paddingLeft","parseInt","getComputedStyle","getTrackIndex","track","Array","prototype","slice","call","querySelectorAll","indexOf","getTrackWrapper","contains","getTrackAndClipIndex","data","id","i","length","j","trackIndex","clipIndex","needShowPrepareTrack","millisecondsToWidth","milliseconds","widthToMilliseconds","getClipInsertIndex","cursorX","start","end","getAvailableStartAndEnd","prepareInsertIndex","pre","next","adjustStartAndEnd","availableRange","insertRange","diff","getTotalDuration","result","lastClip","StyledImageCard","styled","div","ImageCard","onLoaded","blobUrl","fetch","then","response","blob","file","URL","createObjectURL","img","createElement","durationInMs","naturalWidth","naturalHeight","catch","error","alert","message","alt","draggable","className","StyledVideoCard","VideoCard","loop","duration","videoWidth","videoHeight","StyledCard","getAssetCard","handleLoaded","FitType","EffectType","TransitionType","OverlayType","AssetCard","useContext","editorContext","loaded","setLoaded","clip","setClip","asset","assetToClip","handleMove","pos","showPrepareTrack","clientHeight","handleEnd","belowTrack","splice","availableDuration","dragElementWidth","finalStart","finalEnd","newClip","v4","videoAssets","imageAssets","Stage","item","index","SideBar","StyledTrackElement","StyledName","StyledHandle","TrackElement","onUpdate","newStart","originalTrackIndex","filter","handleLeftHandleMove","preClipEnd","handleRightHandleMove","newEnd","nextClipStart","handleHandleEnd","handleClick","onClick","memo","StyledTrackWrapper","StyledTrack","StyledNewPrepareTrack","Track","clips","hoverIndex","border","background","newClipIndex","isNewTrack","oldData","newData","assign","handleUpdate","StyledTracksWrapper","StyledTracks","StyledIndicator","Tracks","trackStyle","handleIndicatorMove","newCurrentTime","StyledEditor","StyledEditorLeft","StyledEditorRight","StyledStageTimeline","StyledTimelineWrapper","StyledRuler","StyledRulerItem","Ruler","setWidth","observer","ResizeObserver","observe","disconnect","from","ceil","value","useKeyboardEventRegister","isKeyPress","targetKey","keyPressed","setKeyPressed","handleKeydown","handleKeyup","useKeyPress","useKeyboard","editorContextValue","useDeleteKey","ClipBase","config","player","isAttachToPainter","isStart","sprite","this","a","isManual","painter","getColorFunction","fitType","ratio","FILL","CONTAIN","COVER","Shader","effect","colorFun","clipRatio","fromFitType","fromEffect","fromRatio","toFitType","toEffect","toRatio","transition","fromColorFun","toColorFun","effectMap","NO_EFFECT","uniforms","fragment","texName","funName","GRAY","effects","Video","originEffect","geometry","material","texture","initRender","setPlaybackRate","watchChange","renderFrame","reject","autoplay","THREE","createTexture","tex","vertexShader","GetVertex","fragmentShader","GetEffectFragment","uniformsNeedUpdate","transparent","newPlaybackRate","getPlaybackRate","abs","playbackRate","paused","play","pause","visible","isInRange","correctVideoCurrentTime","addToPainter","render","removeFromPainter","updateShader","position","z","zIndex","dispose","load","imageWidth","imageHeight","Text","Audio","transitionMap","freeze","MORPH","strength","DREAMY","FADE","Transition","getClipById","fromId","to","toId","fromClip","toClip","fromWidth","fromHeight","fromTexture","toWidth","toHeight","toTexture","fromUniforms","fromFragment","toUniforms","toFragment","transitionUniforms","transitionFragment","progress","GetTransitionFragment","Svg","context","initCanvas","getContext","func","needsUpdate","Painter","scene","camera","renderer","maxAnisotropy","preserveDrawingBuffer","antialias","setPixelRatio","setSize","capabilities","getMaxAnisotropy","selectedObject","getObjectByName","domElement","Lottie","lottie","goToAndStop","TRANSITION","TEXT","AUDIO","SVG","LOTTIE","Player","onCurrentTimeChange","tickTime","tickReq","playing","tickFun","tick","bind","flat","updateDuration","find","init","push","destroy","requestAnimationFrame","performance","now","time","interval","cancelAnimationFrame","len","appendChild","getDomElement","createContext","Editor","playerContainerRef","handleTracksChange","newTracks","newTotalDuration","currentWidth","newWidth","containerRef","setPlaying","attachTo","playerData","newClips","deleteClips","flatNewData","instance","findDiff","addClip","removeClip","usePlayer","handlePlayingChange","Provider","display","justifyContent","ReactDOM","StrictMode","getElementById","module","exports"],"mappings":"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","file":"static/js/main.0cc26dc5.chunk.js","sourcesContent":["export enum AssetType {\n  VIDEO,\n  IMAGE,\n  AUDIO,\n}\n\nexport interface Asset {\n  name: string;\n  type: AssetType;\n}\n\nexport interface VideoAsset extends Asset {\n  url: string;\n}\n\nexport interface ImageAsset extends Asset {\n  url: string;\n}\n\nexport interface AudioAsset extends Asset {\n  url: string;\n}\n","export const IMAGES = [\n  {\n    name: 'dawn',\n    url: 'https://images.unsplash.com/photo-1634322474954-d69e93a8480b?ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&ixlib=rb-1.2.1&auto=format&fit=crop&w=2370&q=80',\n  },\n];\n","import { EffectType, FitType, TransitionType } from './player';\nimport { ClipBase } from '../../player/clips/base';\nimport { OverlayProps } from '../../player/svgs';\nimport { AnimationItem } from 'lottie-web';\nimport * as THREE from 'three';\n\nexport enum ClipType {\n  UNKNOWN,\n  VIDEO,\n  IMAGE,\n  AUDIO,\n  TRANSITION,\n  SVG,\n  LOTTIE,\n  TEXT,\n}\n\nexport type ClipUnionType = ClipType.UNKNOWN | ClipType.VIDEO | ClipType.IMAGE | ClipType.AUDIO;\n\nexport interface Clip {\n  id?: string;\n  name: string;\n  type: ClipType;\n  start: number;\n  end: number;\n  texture: THREE.Texture;\n  durationInMs: number;\n  effect: EffectType;\n  width: number;\n  height: number;\n  fitType: FitType;\n  zIndex: number;\n}\n\nexport interface VideoClip extends Clip {\n  url: string;\n  blobUrl: string;\n}\n\nexport interface ImageClip extends Clip {\n  url: string;\n  blobUrl: string;\n  originalWidth: number;\n  originalHeight: number;\n}\n\nexport interface AudioClip extends Clip {\n  url: string;\n}\n\nexport interface LottieClip extends Clip {\n  lottie: AnimationItem;\n}\n\nexport interface TextClip extends Clip {\n\n}\n\nexport interface SvgClip extends Clip {\n  func(props: OverlayProps): string; \n}\n\nexport interface TransitionClip extends Clip {\n  transition: TransitionType;\n  fromId: string;\n  toId: string;\n  from?: ClipBase<Clip>;\n  to?: ClipBase<Clip>;\n}\n\nexport type ClipObjectType<T> = \n  T extends ClipType.VIDEO ? VideoClip :\n  T extends ClipType.IMAGE ? ImageClip :\n  T extends ClipType.AUDIO ? AudioClip :\n  never;\n","export enum MoveDirection {\n  ALL,\n  EW, // 东西\n  NS, // 北南\n}\n","import { AssetType, ImageAsset, VideoAsset } from '../common/types/asset';\nimport { IMAGES } from './images';\nimport { VIDEOS } from './videos';\n\nexport const ASSET = {\n  videos: VIDEOS.map((video) => ({ type: AssetType.VIDEO, ...video })) as VideoAsset[],\n  images: IMAGES.map((image) => ({ type: AssetType.IMAGE, ...image })) as ImageAsset[],\n  audios: [],\n};\n","export const VIDEOS = [\n  {\n    name: 'leaf',\n    url: 'https://adsmind.gdtimg.com/ads_svp_video__0b533eaaaaaa7iaef32e55qrvwieadmqaaca.f0.mp4?dis_k=db0de64d4f56c2015472040b1d4dbe05&dis_t=1631864114&m=0a60e4eff013efd2db2228ee7b92ac66',\n  },\n  {\n    name: 'sunflower',\n    url: 'https://vod-progressive.akamaized.net/exp=1634469726~acl=%2Fvimeo-prod-skyfire-std-us%2F01%2F2551%2F19%2F487756327%2F2186841038.mp4~hmac=a4e03a6ba76ec92b7ab82c096c2baac10cb00792c645cfaa09de32fc418fa366/vimeo-prod-skyfire-std-us/01/2551/19/487756327/2186841038.mp4?filename=pexels-leonardo-6101754.mp4',\n  },\n];\n","import { Asset, AssetType, VideoAsset } from '../types/asset';\nimport { Clip, ClipType, ImageClip, VideoClip } from '../types/clip';\n\nexport function setStyles(el: HTMLElement, styles: Partial<CSSStyleDeclaration>) {\n  Object.keys(styles).forEach((key) => {\n    // @ts-ignore\n    el.style.setProperty(key.replace(/([A-Z])/g, '-$1').toLowerCase(), styles[key as keyof CSSStyleDeclaration]);\n  });\n}\n\nexport function assetToClip(asset: Asset, start?: number, end?: number): Clip | undefined {\n  switch (asset.type) {\n    case AssetType.VIDEO:\n      return {\n        type: ClipType.VIDEO,\n        name: asset.name,\n        url: (asset as VideoAsset).url,\n        start,\n        end,\n        durationInMs: 0,\n      } as VideoClip;\n    case AssetType.IMAGE:\n      return {\n        type: ClipType.IMAGE,\n        name: asset.name,\n        url: (asset as VideoAsset).url,\n        start,\n        end,\n        durationInMs: 0,\n      } as ImageClip;\n    default:\n      return undefined;\n  }\n}\n\nexport function secondsToTimeFormat(seconds: number) {\n  const date = new Date(0);\n  date.setSeconds(seconds);\n  return date.toISOString().substr(14, 5);\n}\n\nexport function svgToCanvas(svg: string, canvas: HTMLCanvasElement, canvasContext: CanvasRenderingContext2D | null | undefined) {\n  return new Promise((resolve) => {\n    const { width, height } = canvas;\n    const image = new Image();\n    image.width = width;\n    image.height = height;\n    image.onload = function() {\n      if (canvasContext) {\n        canvasContext.clearRect(0, 0, width, height);\n        canvasContext.drawImage(image, 0, 0);\n      }\n      resolve(true);\n    };\n    image.src = `data:image/svg+xml,${svg.trim()}`;\n  });\n}\n\nexport function watch<ObjType>(\n  watchObj: ObjType,\n  key: keyof ObjType,\n  callback: (newVal: ObjType[keyof ObjType], oldVal: ObjType[keyof ObjType]) => void,\n) {\n  let currentVal = watchObj[key];\n  Object.defineProperty(watchObj, key, {\n    get: () => {\n      return currentVal;\n    },\n    set: (newVal: ObjType[keyof ObjType]) => {\n      const oldVal = currentVal;\n      currentVal = newVal;\n      if (newVal !== oldVal) {\n        callback(newVal, oldVal);\n      }\n    },\n  });\n}\n","import React, { ReactElement, useCallback, useEffect, useRef, useState } from 'react';\nimport { setStyles } from '../../utils';\nimport { MoveDirection } from './config';\nimport { DragInfo } from './type';\n\ntype Props<T> = {\n  children: React.ReactElement;\n  direction?: MoveDirection;\n  scrollContainerSelector?: string;\n  autoGrow?: boolean;\n  enable?: boolean;\n  attachData?: T;\n  slow?: number;\n  onMove?(dragInfo: DragInfo<T>): void;\n  onEnd?(dragInfo: DragInfo<T>): void;\n};\n\nconst Draggable = <T extends {}>({\n  children,\n  direction = MoveDirection.ALL,\n  scrollContainerSelector,\n  autoGrow,\n  enable = true,\n  attachData,\n  slow = 1,\n  onMove,\n  onEnd,\n}: Props<T>): JSX.Element => {\n  const childRef = useRef<HTMLElement | null>(null);\n  const shiftX = useRef(0);\n  const shiftY = useRef(0);\n  const timer = useRef(0);\n  const originalStyle = useRef('');\n  const originalLeft = useRef(0);\n  const originalTop = useRef(0);\n  const preLeft = useRef(0);\n  const preTop = useRef(0);\n  const isEnd = useRef(false);\n  const count = useRef(0);\n  const isHoverScrollContainer = useRef(false);\n\n  const [dragInfo, setDragInfo] = useState<DragInfo<T>>();\n  useEffect(() => {\n    if (dragInfo) {\n      if (isEnd.current) {\n        count.current = 0;\n        onEnd?.(dragInfo);\n      } else {\n        count.current = count.current + 1;\n        (count.current % slow) === 0 && onMove?.(dragInfo);\n      }\n      setDragInfo(undefined);\n    }\n  }, [dragInfo, onEnd, onMove, slow]);\n\n  /**\n   * 更新拖拽元素的位置\n   */\n  const move = useCallback((el: HTMLElement, pageX: number, pageY: number) => {\n    let transformStyle = '';\n    if (MoveDirection.ALL === direction) {\n      transformStyle = `translate(${pageX - shiftX.current}px, ${pageY - shiftY.current}px)`;\n    }\n    if (MoveDirection.EW === direction) {\n      transformStyle = `translate(${pageX - shiftX.current}px, ${originalTop.current}px)`;\n    }\n    if (MoveDirection.NS === direction) {\n      transformStyle = `translate(${originalLeft.current}px, ${pageY - shiftY.current}px)`;\n    }\n    el.style.transform = transformStyle;\n  }, [direction]);\n\n  const handleHold = useCallback((step: number, wrapper: HTMLElement, scrollContainer: HTMLElement) => {\n    timer.current = window.setInterval(() => {\n      const wrapperRect = wrapper.getBoundingClientRect();\n      if (step > 0 && autoGrow && (wrapper.scrollLeft + wrapperRect.width) > (scrollContainer.clientWidth - 100)) {\n        scrollContainer.style.width = `${scrollContainer.clientWidth + 100}px`;\n      }\n      wrapper.scrollLeft += step * 2; // hold的时候加快速度\n    }, 1000 / 60);\n  }, [autoGrow]);\n\n  /**\n   * 更新指定容器的滚动位置\n   */\n  const handleScroll = useCallback((below: HTMLElement, pageX: number, pageY: number) => {\n    if (timer) {\n      window.clearInterval(timer.current);\n      timer.current = 0;\n    }\n    if (scrollContainerSelector) {\n      const scrollThreshold = 100;\n      const scrollContainer = document.querySelector(scrollContainerSelector) as HTMLElement;\n      if (!isHoverScrollContainer.current) {\n        if (!below?.closest(scrollContainerSelector)) { // 如果不在滚动容器内，则不滚动\n          return;\n        } else {\n          isHoverScrollContainer.current = true;\n        }\n      }\n      if (scrollContainer?.parentElement) {\n        const wrapper = scrollContainer.parentElement;\n        const wrapperRect = wrapper.getBoundingClientRect();\n        let step = 0;\n        if (pageX > wrapperRect.right - scrollThreshold) { // 向右👉\n          if (autoGrow && (wrapper.scrollLeft + wrapperRect.width) > (scrollContainer.clientWidth - 100)) {\n            scrollContainer.style.width = `${scrollContainer.clientWidth + 100}px`;\n          }\n          step = 5 * (1 + Math.min((pageX - wrapperRect.right + scrollThreshold) / scrollThreshold, 1));\n        } else if (pageX < wrapperRect.left + scrollThreshold) { // 👈向左\n          step = -5 * (1 + Math.min((wrapperRect.left + scrollThreshold - pageX) / scrollThreshold, 1));\n        }\n        if (step !== 0) {\n          wrapper.scrollLeft += step;\n          handleHold(step, wrapper, scrollContainer);\n        }\n      }\n    }\n  }, [autoGrow, handleHold, scrollContainerSelector]);\n\n  const handleMouseMove = useCallback((e: MouseEvent) => {\n    const el = childRef.current;\n    if (el) {\n      el.hidden = true;\n      const below = document.elementFromPoint(e.clientX, e.clientY) as HTMLElement;\n      move(el, e.pageX, e.pageY);\n      handleScroll(below, e.pageX, e.pageY);\n      const currentLeft = e.pageX - shiftX.current;\n      const currentTop = e.pageY - shiftY.current;\n      setDragInfo({\n        element: el,\n        belowElement: below,\n        left: currentLeft,\n        top: currentTop,\n        originalLeft: originalLeft.current,\n        originalTop: originalTop.current,\n        stepLeft: currentLeft - preLeft.current,\n        stepTop: currentTop - preTop.current,\n        cursorLeft: e.pageX,\n        cursorTop: e.pageY,\n        attachData,\n      });\n      preLeft.current = currentLeft;\n      preTop.current = currentTop;\n      el.hidden = false;\n    }\n  }, [move, handleScroll, attachData]);\n\n  const handleMouseUp = useCallback((e: MouseEvent) => {\n    const { pageX, pageY } = e;\n    const el = childRef.current;\n    if (el) {\n      el.hidden = true;\n      const below = document.elementFromPoint(e.clientX, e.clientY) as HTMLElement;\n      el.hidden = false;\n      el.classList.remove('dragged');\n      el.setAttribute('style', originalStyle.current);\n      isEnd.current = true;\n      setDragInfo({\n        element: el,\n        belowElement: below,\n        left: pageX - shiftX.current,\n        top: pageY - shiftY.current,\n        originalLeft: originalLeft.current,\n        originalTop: originalTop.current,\n        stepLeft: 0,\n        stepTop: 0,\n        cursorLeft: pageX,\n        cursorTop: pageY,\n        attachData,\n      });\n    }\n    window.clearInterval(timer.current);\n    window.removeEventListener('mousemove', handleMouseMove, false);\n    window.removeEventListener('mouseup', handleMouseUp, false);\n  }, [attachData, handleMouseMove]);\n\n  const handleMouseDown = useCallback((e: MouseEvent) => {\n    e.stopPropagation();\n    if (childRef.current) {\n      isEnd.current = false;\n      const el = childRef.current;\n      const { left, top, width, height } = el.getBoundingClientRect();\n      shiftX.current = e.clientX - left;\n      shiftY.current = e.clientY - top;\n\n      // 保留原样式\n      originalStyle.current = el.getAttribute('style') || '';\n      originalLeft.current = left;\n      originalTop.current = top;\n      preLeft.current = left;\n      preTop.current = top;\n      isHoverScrollContainer.current = false;\n\n      setStyles(el, {\n        transform: `translate(${left}px, ${top}px)`,\n        width: `${width}px`,\n        height: `${height}px`,\n      });\n      el.classList.add('dragged');\n      move(el, e.pageX, e.pageY);\n      window.addEventListener('mousemove', handleMouseMove, false);\n      window.addEventListener('mouseup', handleMouseUp, false);\n    }\n  }, [handleMouseMove, handleMouseUp, move]);\n\n  useEffect(() => {\n    const container = childRef.current;\n    if (container && enable) {\n      container.addEventListener('mousedown', handleMouseDown, false);\n      return () => {\n        container.removeEventListener('mousedown', handleMouseDown, false);\n      };\n    }\n  }, [childRef, enable, handleMouseDown]);\n  return (\n    <>\n      {\n        React.cloneElement(children as ReactElement, {\n          ref: (ref: HTMLElement) => (childRef.current = ref),\n        })\n      }\n    </>\n  );\n};\n\nexport default Draggable;\n","import { EditorContext } from './type';\n\nexport const TRACK_WRAPPER_CLASS_NAME = 'track-wrapper';\n\nexport const NEW_TRACK_THRESHOLD = 12;\n\n/**\n * 一秒对应的像素宽度\n */\nexport const SECOND_WIDTH = 100;\n\nexport const INIT_EDITOR_CONTEXT: EditorContext = {\n  hoverTrack: null,\n  setHoverTrack: () => {},\n  tracks: [],\n  setTracks: () => {},\n  newTrackIndex: -1,\n  setNewTrackIndex: () => {},\n  activeClipId: '',\n  setActiveClipId: () => {},\n  currentTime: 0,\n  setCurrentTime: () => {},\n  totalDuration: 0,\n  setTotalDuration: () => {},\n};\n","import { Position, Range } from '../common/types';\nimport { Clip } from '../common/types/clip';\nimport { SECOND_WIDTH, TRACK_WRAPPER_CLASS_NAME } from './config';\n\nconst trackWrapperSelector = `.${TRACK_WRAPPER_CLASS_NAME}`;\n\n/**\n * 将光标位置转换为元素内的坐标\n */\nexport function cursorPositionToElementPosition(cursorPosition: Position, element: HTMLElement): Position {\n  if (cursorPosition && element) {\n    const rect = element.getBoundingClientRect();\n    return {\n      x: Math.max(0, cursorPosition.x - rect.x),\n      y: Math.max(0, cursorPosition.y - rect.y),\n    };\n  }\n  return { x: 0, y: 0 };\n}\n\n/**\n * \n */\nexport function cursorPositionToTracksWrapperPosition(cursorPosition: Position) {\n  const tracksWrapper = document.querySelector('.tracks-wrapper') as HTMLElement;\n  if (cursorPosition && tracksWrapper) {\n    const rect = tracksWrapper.getBoundingClientRect();\n    const paddingLeft = parseInt(getComputedStyle(tracksWrapper).paddingLeft, 10);\n    return {\n      x: Math.max(0, cursorPosition.x - rect.x - paddingLeft),\n      y: Math.max(0, cursorPosition.y - rect.y),\n    };\n  }\n  return { x: 0, y: 0 };\n}\n\n/**\n * 获取track index\n */\nexport function getTrackIndex(track?: HTMLElement | null) {\n  if (track) {\n    return Array.prototype.slice.call(track.parentElement?.querySelectorAll(trackWrapperSelector)).indexOf(track);\n  }\n  return -1;\n}\n\nexport function getTrackWrapper(el: HTMLElement) {\n  let parentElement = el?.parentElement;\n  while (parentElement) {\n    if (parentElement.classList.contains(TRACK_WRAPPER_CLASS_NAME)) {\n      return parentElement;\n    }\n    parentElement = parentElement.parentElement;\n  }\n  return null;\n  // return el?.closest(trackWrapperSelector) as HTMLElement;\n}\n\n/**\n * 获取trackElement的trackIndex和clipIndex\n */\nexport function getTrackAndClipIndex(data: Clip[][], id?: string) {\n  for (let i = 0; i < data.length; i++) {\n    for (let j = 0; j < data[i].length; j++) {\n      if (data[i][j].id === id) {\n        return { trackIndex: i, clipIndex: j };\n      }\n    }\n  }\n  return { trackIndex: -1, clipIndex: -1 };\n}\n\nexport function needShowPrepareTrack(data: Clip[][]) {\n  return !(data.length === 0 || (data.length === 1 && data[0].length === 0));\n}\n\nexport function millisecondsToWidth(milliseconds?: number) {\n  return (milliseconds || 0) / 1000 * SECOND_WIDTH;\n}\n\nexport function widthToMilliseconds(width: number) {\n  return width / SECOND_WIDTH * 1000;\n}\n\nexport function getClipInsertIndex(cursorX: number, data: Clip[]) {\n  if (data.length) {\n    for (let i = 0; i < data.length; i++) {\n      const { start, end } = data[i];\n      if (cursorX >= start && cursorX <= end) {\n        return -1;\n      }\n      if (cursorX < start) {\n        return i;\n      }\n    }\n    if (cursorX > data[data.length - 1].end) {\n      return data.length;\n    }\n  }\n  return 0;\n}\n\nexport function getAvailableStartAndEnd(prepareInsertIndex: number, data: Clip[]) {\n  const pre = data[prepareInsertIndex - 1];\n  const next = data[prepareInsertIndex];\n  if (!pre && !next) {\n    return { start: 0, end: 10e9 };\n  }\n  if (!pre && next) {\n    return { start: 0, end: next.start };\n  }\n  if (pre && next) {\n    return { start: pre.end, end: next.start };\n  }\n  if (pre && !next) {\n    return { start: pre.end, end: 10e9 };\n  }\n  return { start: 0, end: 0 };\n}\n\n/**\n * 调整插入范围\n * @param availableRange 当前可供插入的范围\n * @param insertRange 要插入的范围\n */\nexport function adjustStartAndEnd(availableRange: Range, insertRange: Range): Range {\n  if (insertRange[0] >= availableRange[0] && insertRange[1] <= availableRange[1]) {\n    return insertRange;\n  }\n  if (insertRange[0] >= availableRange[0] && insertRange[1] > availableRange[1]) { // 需要左移\n    const diff = insertRange[1] - availableRange[1];\n    return [\n      Math.max(insertRange[0] - diff, availableRange[0]),\n      Math.min(insertRange[1] - diff, availableRange[1]),\n    ];\n  }\n  if (insertRange[0] < availableRange[0] && insertRange[1] <= availableRange[1]) { // 需要右移\n    const diff = availableRange[0] - insertRange[0];\n    return [\n      Math.max(insertRange[0] + diff, availableRange[0]),\n      Math.min(insertRange[1] + diff, availableRange[1]),\n    ];\n  }\n  if (insertRange[0] <= availableRange[0] && insertRange[1] >= availableRange[1]) {\n    return availableRange;\n  }\n  return insertRange;\n}\n\n/**\n * 获取当前编辑内容的总时长\n */\nexport function getTotalDuration(data: Clip[][]) {\n  let result = 0;\n  data.forEach((track) => {\n    if (track?.length) {\n      const lastClip = track[track.length - 1];\n      result = Math.max(result, lastClip.end);\n    }\n  });\n  return result;\n}\n","import styled from 'styled-components';\n\nexport const StyledImageCard = styled.div`\n  width: 100%;\n  height: 100%;\n  border-radius: 6px;\n  cursor: move;\n  overflow: hidden;\n  position: relative;\n\n  img {\n    width: 100%;\n    height: 100%;\n    object-fit: cover;\n    vertical-align: unset;\n  }\n\n  .title {\n    position: absolute;\n    bottom: 10px;\n    left: 10px;\n    color: #fff;\n    text-shadow: #000 15px 5px 5px;\n    font-size: 14px;\n    height: 14px;\n    line-height: 14px;\n  }\n`;\n","import React, { useEffect } from 'react';\nimport { ImageClip } from '../../../../../common/types/clip';\nimport { StyledImageCard } from './styled';\n\ntype Props = {\n  data: ImageClip;\n  onLoaded(data: ImageClip): void;\n};\n\nconst ImageCard: React.FC<Props> = ({ data, onLoaded }) => {\n  useEffect(() => {\n    if (!data.blobUrl) {\n      fetch(data.url).then((response) => {\n        return response.blob();\n      }).then((file: Blob) => {\n        const blobUrl = URL.createObjectURL(file);\n        const img = document.createElement('img');\n        img.addEventListener('load', () => {\n          onLoaded({\n            ...data,\n            durationInMs: 2000,\n            width: img.naturalWidth,\n            height: img.naturalHeight,\n            blobUrl,\n          });\n        });\n        img.src = blobUrl;\n      }).catch((error) => {\n        alert(error.message);\n      });\n    }\n  }, [data, onLoaded]);\n  return (\n    <StyledImageCard>\n      <img src={data.url} alt=\"\" draggable=\"false\" />\n      <div className=\"title\">{data.name}</div>\n    </StyledImageCard>\n  );\n};\n\nexport default ImageCard;\n","import styled from 'styled-components';\n\nexport const StyledVideoCard = styled.div`\n  width: 100%;\n  height: 100%;\n  border-radius: 6px;\n  cursor: move;\n  overflow: hidden;\n  position: relative;\n\n  video {\n    width: 100%;\n    height: 100%;\n    object-fit: cover;\n  }\n\n  .title {\n    position: absolute;\n    bottom: 10px;\n    left: 10px;\n    color: #fff;\n    text-shadow: #000 15px 5px 5px;\n    font-size: 14px;\n    height: 14px;\n    line-height: 14px;\n  }\n`;\n","import React, { useEffect } from 'react';\nimport { VideoClip } from '../../../../../common/types/clip';\nimport { StyledVideoCard } from './styled';\n\ntype Props = {\n  data: VideoClip;\n  onLoaded(data: VideoClip): void;\n};\n\nconst VideoCard: React.FC<Props> = ({ data, onLoaded }) => {\n  useEffect(() => {\n    if (!data.blobUrl) {\n      fetch(data.url).then((response) => {\n        return response.blob();\n      }).then((file: Blob) => {\n        const blobUrl = URL.createObjectURL(file);\n        const video = document.createElement('video');\n        video.loop = false;\n        video.addEventListener('loadeddata', () => {\n          onLoaded({\n            ...data,\n            durationInMs: video.duration * 1000,\n            width: video.videoWidth,\n            height: video.videoHeight,\n            blobUrl,\n          });\n        });\n        video.src = blobUrl;\n      }).catch((error) => {\n        alert(error.message);\n      });\n    }\n  }, [data, onLoaded]);\n  return (\n    <StyledVideoCard>\n      <video src={data.url} />\n      <div className=\"title\">{data.name}</div>\n    </StyledVideoCard>\n  );\n};\n\nexport default VideoCard;\n","import styled from 'styled-components';\n\nexport const StyledCard = styled.div`\n  width: 125px;\n  height: 70px;\n  line-height: 70px;\n  text-align: center;\n  border-radius: 6px;\n  background-color: #949494;\n  cursor: pointer;\n`;\n","import React, { useCallback, useContext, useEffect, useState } from 'react';\nimport { v4 } from 'uuid';\nimport { editorContext } from '../..';\nimport Draggable from '../../../common/components/Draggable';\nimport { MoveDirection } from '../../../common/components/Draggable/config';\nimport { DragInfo } from '../../../common/components/Draggable/type';\nimport { Asset } from '../../../common/types/asset';\nimport { Clip, ClipType, ImageClip, VideoClip } from '../../../common/types/clip';\nimport { assetToClip } from '../../../common/utils';\nimport { NEW_TRACK_THRESHOLD } from '../../config';\nimport {\n  adjustStartAndEnd,\n  cursorPositionToElementPosition,\n  cursorPositionToTracksWrapperPosition,\n  getAvailableStartAndEnd,\n  getClipInsertIndex,\n  getTrackIndex,\n  getTrackWrapper,\n  millisecondsToWidth,\n  needShowPrepareTrack,\n  widthToMilliseconds,\n} from '../../util';\nimport ImageCard from './components/ImageCard';\nimport VideoCard from './components/VideoCard';\nimport { StyledCard } from './styled';\n\nfunction getAssetCard(data: Clip | undefined, handleLoaded: (data: Clip) => void) {\n  switch (data?.type) {\n    case ClipType.VIDEO:\n      return <VideoCard data={data as VideoClip} onLoaded={handleLoaded} />;\n    case ClipType.IMAGE:\n      return <ImageCard data={data as ImageClip} onLoaded={handleLoaded} />;\n    default:\n      return null;\n  }\n}\n\ntype Props = {\n  data: Asset;\n};\n\nconst AssetCard: React.FC<Props> = ({ data }) => {\n  const { setHoverTrack, tracks, setTracks, setNewTrackIndex, newTrackIndex } = useContext(editorContext);\n  const [loaded, setLoaded] = useState(false);\n  const [clip, setClip] = useState<Clip>();\n\n  useEffect(() => {\n    setClip(assetToClip(data));\n  }, [data]);\n\n  const handleMove = useCallback((dragInfo: DragInfo<Asset>) => {\n    const hoverTrack = getTrackWrapper(dragInfo.belowElement);\n    if (hoverTrack) {\n      const pos = cursorPositionToElementPosition({ x: dragInfo.cursorLeft, y: dragInfo.cursorTop }, hoverTrack);\n      const showPrepareTrack = needShowPrepareTrack(tracks);\n      const trackIndex = getTrackIndex(hoverTrack);\n      if (pos.y <= NEW_TRACK_THRESHOLD && showPrepareTrack) {\n        setNewTrackIndex(trackIndex);\n      } else if (pos.y >= hoverTrack.clientHeight - NEW_TRACK_THRESHOLD && showPrepareTrack) {\n        setNewTrackIndex(trackIndex + 1);\n      } else {\n        setNewTrackIndex(-1);\n      }\n    }\n    setHoverTrack(hoverTrack);\n  }, [setHoverTrack, setNewTrackIndex, tracks]);\n\n  const handleEnd = useCallback((dragInfo: DragInfo<Asset>) => {\n    const belowTrack = getTrackWrapper(dragInfo.belowElement);\n    const pos = cursorPositionToTracksWrapperPosition({ x: dragInfo.cursorLeft, y: dragInfo.cursorTop });\n    let trackIndex = -1;\n    if (newTrackIndex > -1) {\n      trackIndex = newTrackIndex;\n      tracks.splice(trackIndex, 0, []);\n    } else if (belowTrack) {\n      trackIndex = getTrackIndex(belowTrack);\n    }\n    const track = tracks[trackIndex];\n    if (trackIndex > -1 && track) {\n      // 获取将要插入的索引\n      const prepareInsertIndex = getClipInsertIndex(widthToMilliseconds(pos.x), track);\n      if (prepareInsertIndex > -1) {\n        // 获取可供插入的范围\n        const availableDuration = getAvailableStartAndEnd(prepareInsertIndex, track);\n        if (availableDuration.start || availableDuration.end) {\n          const duration = clip?.durationInMs || 0;\n          const width = millisecondsToWidth(duration); // 拖拽的元素放到track上的宽度\n          const dragElementWidth = dragInfo.element.clientWidth;\n          const shiftX = dragInfo.cursorLeft - dragInfo.left;\n          const start = widthToMilliseconds(Math.max(0, pos.x - (shiftX / dragElementWidth) * width));\n          const [finalStart, finalEnd] = adjustStartAndEnd(\n            [availableDuration.start, availableDuration.end],\n            [start, start + duration]\n          );\n          const newClip = {\n            ...clip,\n            id: v4(),\n            start: finalStart,\n            end: finalEnd,\n            durationInMs: finalEnd - finalStart,\n          } as Clip;\n          track.splice(prepareInsertIndex, 0, newClip);\n          setTracks([...tracks]);\n        }\n      }\n    }\n    setNewTrackIndex(-1);\n    setHoverTrack(null);\n  }, [clip, newTrackIndex, setHoverTrack, setNewTrackIndex, setTracks, tracks]);\n\n  const handleLoaded = useCallback((data: Clip) => {\n    setClip({ ...clip, ...data });\n    setLoaded(true);\n  }, [clip]);\n\n  return (\n    <Draggable\n      direction={MoveDirection.ALL}\n      scrollContainerSelector=\".tracks-wrapper\"\n      autoGrow={true}\n      enable={loaded}\n      slow={2}\n      onMove={handleMove}\n      onEnd={handleEnd}\n    >\n      <StyledCard>\n        {getAssetCard(clip, handleLoaded)}\n      </StyledCard>\n    </Draggable>\n  );\n};\n\nexport default AssetCard;\n","import { ObjectType } from '.';\n\nexport enum FitType {\n  FILL, // 铺满整个播放器，不考虑长宽比\n  CONTAIN, // 保持长宽比，不会被裁剪，可能没法铺满整个播放器\n  COVER, // 铺满整个播放器，同时保持长宽比，可能存在裁剪\n}\n\nexport enum EffectType {\n  NO_EFFECT,\n  BLUR,\n  GRAY,\n}\n\nexport interface Effect {\n  uniforms: ObjectType;\n  fragment: (texName?: string, funName?: string) => string;\n}\n\nexport enum TransitionType {\n  MORPH,\n  DREAMY,\n  FADE,\n}\n\nexport enum OverlayType {\n  PLUNGING,\n}\n","import React from 'react';\nimport { ASSET } from '../../../asset';\nimport AssetCard from '../AssetCard';\n\nconst videoAssets = ASSET.videos;\nconst imageAssets = ASSET.images;\n\nconst Stage: React.FC = () => {\n  return (\n    <div>\n      {\n        videoAssets.map((item, index) => {\n          return (\n            <div key={index} style={{ width: 125, height: 75 }}>\n              <AssetCard data={item} />\n            </div>\n          );\n        })\n      }\n      {\n        imageAssets.map((item, index) => {\n          return (\n            <div key={index} style={{ width: 125, height: 75 }}>\n              <AssetCard data={item} />\n            </div>\n          );\n        })\n      }\n    </div>\n  );\n};\n\nexport default Stage;\n","import React from 'react';\n\nconst SideBar: React.FC = () => {\n  return (<>Side Bar</>);\n};\n\nexport default SideBar;\n","import styled from 'styled-components';\n\nexport const StyledTrackElement = styled.div`\n  background-color: rgb(69 211 174);\n  border-radius: 5px;\n  height: 100%;\n  position: absolute;\n  top: 0;\n  bottom: 0;\n  overflow: hidden;\n  display: flex;\n  &.active {\n    box-shadow: 0px 0px 10px 0px rgb(69 211 174);\n  }\n`;\n\nexport const StyledLeftHandler = styled.div`\n  position: absolute;\n  width: 10px;\n  height: 100%;\n  left: 0;\n  top: 0;\n  bottom: 0;\n  background: rgba(255, 255, 255, 0.8);\n`;\n\nexport const StyledRightHandler = styled.div`\n  position: absolute;\n  width: 10px;\n  height: 100%;\n  right: 0;\n  top: 0;\n  bottom: 0;\n  background: rgba(255, 255, 255, 0.8);\n`;\n\nexport const StyledName = styled.div`\n  color: #fff;\n  height: 100%;\n  display: flex;\n  align-items: center;\n  padding-left: 10px;\n  flex-grow: 1;\n  text-overflow: ellipsis;\n  overflow: hidden;\n  white-space: nowrap;\n`;\n\nexport const StyledHandle = styled.div`\n  background: #fff;\n  width: 20px;\n  cursor: ew-resize;\n  flex-shrink: 0;\n`;\n","import React, { memo, useCallback, useContext } from 'react';\nimport { editorContext } from '../../../..';\nimport Draggable from '../../../../../common/components/Draggable';\nimport { MoveDirection } from '../../../../../common/components/Draggable/config';\nimport { DragInfo } from '../../../../../common/components/Draggable/type';\nimport { Asset } from '../../../../../common/types/asset';\nimport { Clip } from '../../../../../common/types/clip';\nimport { NEW_TRACK_THRESHOLD } from '../../../../config';\nimport {\n  adjustStartAndEnd,\n  cursorPositionToElementPosition,\n  cursorPositionToTracksWrapperPosition,\n  getAvailableStartAndEnd,\n  getClipInsertIndex,\n  getTrackAndClipIndex,\n  getTrackIndex,\n  getTrackWrapper,\n  millisecondsToWidth,\n  needShowPrepareTrack,\n  widthToMilliseconds,\n} from '../../../../util';\nimport { StyledHandle, StyledName, StyledTrackElement } from './styled';\n\ninterface Props extends Clip {\n  onUpdate?(data: Partial<Clip>, trackIndex: number, clipIndex: number, isNewTrack: boolean): void;\n}\n\nconst TrackElement: React.FC<Props> = ({ start, end, onUpdate, durationInMs, name, id }) => {\n  const {\n    setHoverTrack,\n    tracks,\n    setNewTrackIndex,\n    newTrackIndex,\n    activeClipId,\n    setActiveClipId,\n  } = useContext(editorContext);\n\n  const handleMove = useCallback((dragInfo: DragInfo<Asset>) => {\n    const hoverTrack = getTrackWrapper(dragInfo.belowElement);\n    if (hoverTrack) {\n      const pos = cursorPositionToElementPosition({ x: dragInfo.cursorLeft, y: dragInfo.cursorTop }, hoverTrack);\n      const showPrepareTrack = needShowPrepareTrack(tracks);\n      const trackIndex = getTrackIndex(hoverTrack);\n      if (pos.y <= NEW_TRACK_THRESHOLD && showPrepareTrack) {\n        setNewTrackIndex(trackIndex);\n      } else if (pos.y >= hoverTrack.clientHeight - NEW_TRACK_THRESHOLD && showPrepareTrack) {\n        setNewTrackIndex(trackIndex + 1);\n      } else {\n        setNewTrackIndex(-1);\n      }\n    }\n    setHoverTrack(hoverTrack);\n  }, [setHoverTrack, setNewTrackIndex, tracks]);\n\n  const handleEnd = useCallback((dragInfo: DragInfo<Asset>) => {\n    const belowTrack = getTrackWrapper(dragInfo.belowElement);\n    const pos = cursorPositionToTracksWrapperPosition({ x: dragInfo.cursorLeft, y: dragInfo.cursorTop });\n    let newStart = widthToMilliseconds(Math.max(0, pos.x - (dragInfo.cursorLeft - dragInfo.left)));\n    if (newTrackIndex > -1) {\n      onUpdate?.({ start: newStart, end: newStart + durationInMs }, newTrackIndex, 0, true);\n    } else if (belowTrack) {\n      let trackIndex = getTrackIndex(belowTrack);\n      const { trackIndex: originalTrackIndex } = getTrackAndClipIndex(tracks, id);\n      let track = tracks[trackIndex];\n      if (trackIndex === originalTrackIndex) {\n        track = track.filter((item) => item.id !== id);\n      }\n      if (trackIndex > -1 && track) {\n        const prepareInsertIndex = getClipInsertIndex(widthToMilliseconds(pos.x), track);\n        if (prepareInsertIndex > -1) {\n          const availableDuration = getAvailableStartAndEnd(prepareInsertIndex, track);\n          if (availableDuration.start || availableDuration.end) {\n            const [start, end] = adjustStartAndEnd(\n              [availableDuration.start, availableDuration.end],\n              [newStart, newStart + durationInMs]\n            );\n            onUpdate?.({ start, end, durationInMs: end - start }, trackIndex, prepareInsertIndex, false);\n          }\n        }\n      }\n    }\n    setNewTrackIndex(-1);\n    setHoverTrack(null);\n  }, [durationInMs, id, newTrackIndex, onUpdate, setHoverTrack, setNewTrackIndex, tracks]);\n\n  const handleLeftHandleMove = useCallback((dragInfo: DragInfo<Asset>) => {\n    const newStart = start + widthToMilliseconds(dragInfo.stepLeft);\n    if (end - newStart >= 500) {\n      const { trackIndex, clipIndex } = getTrackAndClipIndex(tracks, id);\n      const preClipEnd = tracks[trackIndex][clipIndex - 1]?.end || 0;\n      onUpdate?.({ start: Math.max(newStart, preClipEnd) }, trackIndex, clipIndex, false);\n    }\n  }, [end, id, onUpdate, start, tracks]);\n\n  const handleRightHandleMove = useCallback((dragInfo: DragInfo<Asset>) => {\n    const newEnd = end + widthToMilliseconds(dragInfo.stepLeft);\n    if (newEnd - start >= 500) {\n      const { trackIndex, clipIndex } = getTrackAndClipIndex(tracks, id);\n      const nextClipStart = tracks[trackIndex][clipIndex + 1]?.start || 10e9;\n      onUpdate?.({ end: Math.min(newEnd, nextClipStart) }, trackIndex, clipIndex, false);\n    }\n  }, [end, start, tracks, id, onUpdate]);\n\n  /**\n   * 拖拽结束的时候更新duration\n   */\n  const handleHandleEnd = useCallback(() => {\n    const { trackIndex, clipIndex } = getTrackAndClipIndex(tracks, id);\n    onUpdate?.({ durationInMs: end - start }, trackIndex, clipIndex, false);\n  }, [end, id, onUpdate, start, tracks]);\n\n  const handleClick = useCallback(() => {\n    setActiveClipId(id || '');\n  }, [id, setActiveClipId]);\n\n  return (\n    <Draggable\n      scrollContainerSelector=\".tracks-wrapper\"\n      autoGrow={true}\n      slow={2}\n      onMove={handleMove}\n      onEnd={handleEnd}\n    >\n      <StyledTrackElement\n        className={activeClipId === id ? 'active' : ''}\n        onClick={handleClick}\n        style={{ width: millisecondsToWidth(end - start), left: millisecondsToWidth(start) }}\n      >\n        <StyledHandle>\n          <Draggable\n            direction={MoveDirection.EW}\n            onMove={handleLeftHandleMove}\n            onEnd={handleHandleEnd}\n          >\n            <div style={{ width: '100%', height: '100%' }}></div>\n          </Draggable>\n        </StyledHandle>\n        <StyledName>{id}</StyledName>\n        <StyledHandle>\n          <Draggable\n            direction={MoveDirection.EW}\n            onMove={handleRightHandleMove}\n            onEnd={handleHandleEnd}\n          >\n            <div style={{ width: '100%', height: '100%' }}></div>\n          </Draggable>\n        </StyledHandle>\n      </StyledTrackElement>\n    </Draggable>\n  );\n};\n\nexport default memo(TrackElement);\n","import styled from 'styled-components';\n\nexport const StyledTrackWrapper = styled.div`\n  width: 100%;\n  height: 40px;\n  padding: 5px 0px;\n`;\n\nexport const StyledTrack = styled.div`\n  width: 100%;\n  height: 100%;\n  border: 2px dashed rgb(60, 60, 72);\n  border-radius: 5px;\n  position: relative;\n  transition: background 0.5s linear;\n`;\n\nexport const StyledNewPrepareTrack = styled.div`\n  height: 0;\n  position: relative;\n  pointer-events: none;\n  &::after {\n    content: '';\n    position: absolute;\n    background: rgb(69 211 174);\n    width: 100%;\n    height: 2px;\n    border-radius: 2px;\n    left: 0;\n    right: 0;\n    top: -1px;\n  }\n  &::before {\n    content: '+';\n    position: absolute;\n    left: 50%;\n    top: 50%;\n    width: 20px;\n    height: 20px;\n    border-radius: 10px;\n    background: rgb(69 211 174);\n    transform: translate(-10px, -10px);\n    text-align: center;\n    line-height: 20px;\n    z-index: 1;\n  }\n`;\n","import React, { useContext } from 'react';\nimport { editorContext } from '../../../..';\nimport { Clip } from '../../../../../common/types/clip';\nimport { TRACK_WRAPPER_CLASS_NAME } from '../../../../config';\nimport { getTrackAndClipIndex, getTrackIndex, needShowPrepareTrack } from '../../../../util';\nimport TrackElement from '../TrackElement';\nimport { StyledNewPrepareTrack, StyledTrack, StyledTrackWrapper } from './styled';\n\ntype Props = {\n  clips: Clip[];\n  index: number;\n  style?: React.CSSProperties;\n};\n\nconst Track: React.FC<Props> = ({ clips, style, index }) => {\n  const { hoverTrack, tracks, setTracks, newTrackIndex } = useContext(editorContext);\n  const hoverIndex = getTrackIndex(hoverTrack);\n  function handleUpdate(oldData: Clip, newData: Partial<Clip>, newTrackIndex: number, newClipIndex: number, isNewTrack: boolean) {\n    // 获取原数据所在索引\n    const { trackIndex, clipIndex } = getTrackAndClipIndex(tracks, oldData.id);\n    if (trackIndex > -1 && clipIndex > -1) {\n      // 删除原clip\n      const oldData = tracks[trackIndex].splice(clipIndex, 1)[0];\n      Object.assign(oldData, newData);\n      if (isNewTrack) {\n        tracks.splice(newTrackIndex, 0, [oldData]);\n      } else {\n        tracks[newTrackIndex].splice(newClipIndex, 0, oldData);\n      }\n      setTracks([...tracks]);\n    }\n  }\n  const showPrepareTrack = needShowPrepareTrack(tracks);\n  return (\n    <>\n      {\n        showPrepareTrack && newTrackIndex === index ? <StyledNewPrepareTrack /> : null\n      }\n      <StyledTrackWrapper style={style} className={TRACK_WRAPPER_CLASS_NAME}>\n        <StyledTrack\n          style={{\n            ...(clips.length ? { border: 0, background: '#1c1c28' } : null),\n            ...(hoverIndex === index && newTrackIndex === -1 ? { background: '#313146' } : null)\n          }}\n        >\n          {\n            clips.map((clip) => {\n              return (\n                <TrackElement\n                  key={clip.id}\n                  {...clip}\n                  onUpdate={(data: Partial<Clip>, newTrackIndex: number, newClipIndex: number, isNewTrack: boolean) => {\n                    handleUpdate(clip, data, newTrackIndex, newClipIndex, isNewTrack);\n                  }}\n                />\n              );\n            })\n          }\n        </StyledTrack>\n      </StyledTrackWrapper>\n      {\n        showPrepareTrack && newTrackIndex === index + 1 ? <StyledNewPrepareTrack /> : null\n      }\n    </>\n  );\n};\n\nexport default Track;\n","import styled from 'styled-components';\n\nexport const StyledTracksWrapper = styled.div`\n  display: flex;\n  height: 100%;\n  /* width: 3000px; */\n  padding: 0 20px;\n  position: relative;\n`;\n\nexport const StyledTracks = styled.div`\n  flex: 1 1 0%;\n  display: flex;\n  flex-direction: column;\n  -webkit-box-pack: center;\n  justify-content: center;\n`;\n\nexport const StyledIndicator = styled.div`\n  width: 0;\n  top: 0;\n  bottom: 4px;\n  position: absolute;\n  cursor: move;\n\n  &::before {\n    content: '';\n    width: 2px;\n    background-color: #fff;\n    left: -1px;\n    top: -10px;\n    bottom: 0;\n    border-radius: 2px;\n    position: absolute;\n  }\n\n  &::after {\n    content: '';\n    position: absolute;\n    top: -20px;\n    left: -10px;\n    border-radius: 4px;\n    width: 0;\n    height: 0;\n    border-left: 10px solid transparent;\n    border-right: 10px solid transparent;\n    border-top: 10px solid #fff;\n  }\n`;\n","import React, { useCallback, useContext } from 'react';\nimport { editorContext } from '../..';\nimport Draggable from '../../../common/components/Draggable';\nimport { MoveDirection } from '../../../common/components/Draggable/config';\nimport { DragInfo } from '../../../common/components/Draggable/type';\nimport { Asset } from '../../../common/types/asset';\nimport { cursorPositionToTracksWrapperPosition, getTotalDuration, millisecondsToWidth, widthToMilliseconds } from '../../util';\nimport Track from './components/Track';\nimport { StyledIndicator, StyledTracks, StyledTracksWrapper } from './styled';\n\nconst Tracks: React.FC = () => {\n  const { tracks, currentTime, setCurrentTime } = useContext(editorContext);\n  const trackStyle: React.CSSProperties = tracks.length === 1 && tracks[0].length === 0 ? { height: 60 } : {};\n  const handleIndicatorMove = useCallback((dragInfo: DragInfo<Asset>) => {\n    const totalDuration = getTotalDuration(tracks);\n    const pos = cursorPositionToTracksWrapperPosition({ x: dragInfo.cursorLeft, y: dragInfo.cursorTop });\n    const newCurrentTime = widthToMilliseconds(Math.max(0, pos.x - (dragInfo.cursorLeft - dragInfo.left)));\n    setCurrentTime(Math.min(newCurrentTime, totalDuration));\n  }, [setCurrentTime, tracks]);\n  return (\n    <StyledTracksWrapper className=\"tracks-wrapper\">\n      <StyledTracks>\n        {\n          tracks.map((clips, index) => {\n            return (\n              <Track index={index} clips={clips} key={index} style={trackStyle} />\n            );\n          })\n        }\n      </StyledTracks>\n      <Draggable\n        scrollContainerSelector=\".tracks-wrapper\"\n        autoGrow={false}\n        direction={MoveDirection.EW}\n        onEnd={handleIndicatorMove}\n      >\n        <StyledIndicator style={{ left: millisecondsToWidth(currentTime) + 20 }} />\n      </Draggable>\n    </StyledTracksWrapper>\n  );\n};\n\nexport default Tracks;\n","import styled from 'styled-components';\n\nexport const StyledEditor = styled.div`\n  display: flex;\n  width: 100%;\n  height: 100%;\n  user-select: none;\n  overflow: hidden;\n`;\n\nexport const StyledEditorLeft = styled.div`\n  display: flex;\n  height: 100%;\n  position: relative;\n  z-index: 5;\n`;\n\nexport const StyledEditorRight = styled.div`\n  display: flex;\n  flex: 1 1 0%;\n  flex-direction: column;\n  overflow: hidden;\n`;\n\nexport const StyledStageTimeline = styled.div`\n  flex: 1 1 0%;\n  padding-top: 24px;\n  display: grid;\n  grid-template-rows: minmax(200px, 1.2fr) minmax(200px, 0.8fr);\n  overflow: hidden;\n`;\n\nexport const StyledTimelineWrapper = styled.div`\n  background-color: #17171e;\n  overflow: auto;\n  display: flex;\n  flex-direction: column;\n`;\n","import styled from 'styled-components';\n\nexport const StyledRuler = styled.div`\n  border-top: 1px solid rgb(60, 60, 72);\n  padding: 0 20px;\n  display: flex;\n  overflow: hidden;\n  flex-grow: 0;\n  flex-shrink: 0;\n`;\n\nexport const StyledRulerItem = styled.div`\n  position: relative;\n  height: 20px;\n  padding: 8px 5px;\n  font-size: 12px;\n  line-height: 12px;\n  color: rgb(88, 88, 88);\n  flex-grow: 0;\n  flex-shrink: 0;\n  &::before {\n    content: '';\n    position: absolute;\n    left: 0;\n    top: 0;\n    bottom: 0;\n    width: 1px;\n    height: 20px;\n    background-color: rgb(60, 60, 72);\n  }\n  &::after {\n    content: '';\n    position: absolute;\n    left: 50%;\n    top: 0;\n    bottom: 0;\n    width: 1px;\n    height: 12px;\n    background-color: rgb(60, 60, 72);\n  }\n`;\n\n","import React, { useEffect, useState } from 'react';\nimport { secondsToTimeFormat } from '../../../common/utils';\nimport { SECOND_WIDTH } from '../../config';\nimport { StyledRuler, StyledRulerItem } from './styled';\n\nconst Ruler: React.FC = () => {\n  const [width, setWidth] = useState(0);\n  useEffect(() => {\n    const tracksWrapper = document.querySelector('.tracks-wrapper') as HTMLElement;\n    if (tracksWrapper) {\n      setWidth(tracksWrapper.clientWidth);\n      const observer = new ResizeObserver(() => {\n        const tracksWrapperWidth = tracksWrapper.clientWidth;\n        if (tracksWrapperWidth !== width) {\n          setWidth(tracksWrapper.clientWidth);\n        }\n      });\n      observer.observe(tracksWrapper)\n      return () => {\n        observer.disconnect();\n      };\n    }\n  }, [width]);\n  return (\n    <StyledRuler style={{ width }}>\n      {\n        Array.from(Array(Math.ceil(width / SECOND_WIDTH))).map((value, index) => {\n          return (\n            <StyledRulerItem key={index} style={{ width: SECOND_WIDTH }}>\n              {secondsToTimeFormat(index)}\n            </StyledRulerItem>\n          );\n        })\n      }\n    </StyledRuler>\n  );\n};\n\nexport default Ruler;\n","import { useCallback, useEffect, useState } from 'react';\n\nexport const useKeyPress = (targetKey: string): boolean => {\n  // State for keeping track of whether key is pressed\n  const [keyPressed, setKeyPressed] = useState(false);\n\n  // If pressed key is our target key then set to true\n  const handleKeydown = useCallback((e: KeyboardEvent) => {\n    if (e.key === targetKey) {\n      setKeyPressed(true);\n    }\n  }, [targetKey]);\n\n  // If released key is our target key then set to false\n  const handleKeyup = useCallback((e: KeyboardEvent): void => {\n    if (e.key === targetKey) {\n      setKeyPressed(false);\n    }\n  }, [targetKey]);\n\n  // Add event listeners\n  useEffect(() => {\n    window.removeEventListener('keydown', handleKeydown);\n    window.removeEventListener('keyup', handleKeyup);\n\n    window.addEventListener('keydown', handleKeydown);\n    window.addEventListener('keyup', handleKeyup);\n    // Remove event listeners on cleanup\n    return () => {\n      window.removeEventListener('keydown', handleKeydown);\n      window.removeEventListener('keyup', handleKeyup);\n    };\n  }, [handleKeydown, handleKeyup]); // Empty array ensures that effect is only run on mount and unmount\n\n  return keyPressed;\n};\n\nexport const useKeyboardEventRegister = (key: string, callback: () => void) => {\n  const isKeyPress = useKeyPress(key);\n  useEffect(() => {\n    if (isKeyPress) {\n      callback?.();\n    }\n  }, [callback, isKeyPress]);\n};\n","import { useKeyboardEventRegister } from '.';\nimport { EditorContext } from '../type';\nimport { getTrackAndClipIndex } from '../util';\n\nexport const useDeleteKey = (editorContextValue: EditorContext) => {\n  const { tracks, activeClipId, setTracks } = editorContextValue;\n  useKeyboardEventRegister('Backspace', () => {\n    const { trackIndex, clipIndex } = getTrackAndClipIndex(tracks, activeClipId);\n    if (trackIndex > -1 && clipIndex > -1) {\n      tracks[trackIndex].splice(clipIndex, 1);\n      setTracks([...tracks]);\n    }\n  });\n};\n\nexport const useKeyboard = (editorContextValue: EditorContext) => {\n  useDeleteKey(editorContextValue);\n};\n","import Player from '..';\nimport * as THREE from 'three';\nimport { Clip } from '../../common/types/clip';\n\nexport abstract class ClipBase<T extends Clip = Clip> {\n  private isAttachToPainter: boolean = false;\n\n  public isStart: boolean = false;\n  public player: Player;\n  public sprite: THREE.Mesh | undefined;\n  public config: T;\n\n  constructor(config: T, player: Player) {\n    this.config = config;\n    this.player = player;\n    this.isAttachToPainter = false;\n    this.isStart = false;\n  }\n\n  async init() {}\n\n  onCurrentTimeChange(isManual: boolean) {\n  }\n\n  pause() {\n  }\n\n  addToPainter() {\n    if (!this.isAttachToPainter && this.sprite && this.config.id) {\n      this.isAttachToPainter = true;\n      this.player.painter.add(this.sprite, this.config.id);\n    }\n  }\n\n  removeFromPainter() {\n    if (this.isAttachToPainter && this.config.id) {\n      this.isAttachToPainter = false;\n      this.player.painter.remove(this.config.id);\n    }\n  }\n\n  abstract render(): void;\n  abstract destroy(): void;\n}\n","/**\n * 组装transition和effect\n */\nimport { FitType } from '../../common/types/player';\n\ntype EffectProps = {\n  fitType: FitType;\n  effect: string;\n  clipRatio: number;\n};\n\ntype TransitionProps = {\n  fromFitType: FitType;\n  fromEffect: string;\n  fromRatio: number;\n  toFitType: FitType\n  toEffect: string;\n  toRatio: number;\n  transition: string;\n};\n\nfunction getColorFunction(fitType: FitType, ratio: number) {\n  switch (fitType) {\n    case FitType.FILL:\n      return 'uv';\n    case FitType.CONTAIN:\n      return `.5+(uv-.5)*vec2(max(ratio/${ratio},1.),max(${ratio}/ratio,1.))`;\n    case FitType.COVER:\n      return `.5+(uv-.5)*vec2(min(ratio/${ratio},1.),min(${ratio}/ratio,1.))`;\n  }\n}\n\nexport class Shader {\n  static GetVertex() {\n    const vertexTemplate = `\n      varying vec2 texCoords;\n      void main() {\n        texCoords = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n      }\n    `;\n    return vertexTemplate;\n  }\n\n  static GetFragment() {\n    const fragTemplate = `\n      varying vec2 texCoords;\n      uniform sampler2D tex;\n      void main() {\n        gl_FragColor = texture2D(tex, texCoords);\n      }\n    `;\n    return fragTemplate;\n  }\n\n  static GetEffectFragment({ \n    fitType = FitType.CONTAIN,\n    effect,\n    clipRatio,\n  }: EffectProps) {\n    const colorFun = getColorFunction(fitType, clipRatio);\n    const fragTemplate = `\n      varying vec2 texCoords;\n      uniform float ratio;\n      uniform sampler2D tex;\n      ${effect}\n      vec4 getColor(vec2 uv) {\n        vec2 newUV = ${colorFun};\n        vec4 color = effect(newUV);\n        if(newUV.x>1. || newUV.x<0. || newUV.y>1. || newUV.y<0.){\n          return vec4(0.,0.,0.,0.);\n        }\n        return color;\n      }\n      void main() {\n        gl_FragColor = getColor(texCoords);\n      }\n    `;\n    return fragTemplate;\n  }\n\n  static GetTransitionFragment({\n    fromFitType = FitType.CONTAIN,\n    fromEffect,\n    fromRatio,\n    toFitType = FitType.CONTAIN,\n    toEffect,\n    toRatio,\n    transition,\n  }: TransitionProps) {\n    const fromColorFun = getColorFunction(fromFitType, fromRatio);\n    const toColorFun = getColorFunction(toFitType, toRatio);\n    const fragTemplate = `\n      varying vec2 texCoords;\n      uniform sampler2D from, to;\n      uniform float fromRatio, toRatio;\n      uniform float progress, ratio;\n      ${fromEffect}\n      ${toEffect}\n      vec4 getFromColor(vec2 uv) {\n        vec2 newUV = ${fromColorFun};\n        vec4 color = fromEffect(newUV);\n        if(newUV.x>1. || newUV.x<0. || newUV.y>1. || newUV.y<0.){\n          return vec4(0.,0.,0.,0.);\n        }\n        return color;\n      }\n      vec4 getToColor(vec2 uv) {\n        vec2 newUV = ${toColorFun};\n        vec4 color = toEffect(newUV);\n        if(newUV.x>1. || newUV.x<0. || newUV.y>1. || newUV.y<0.){\n          return vec4(0.,0.,0.,0.);\n        }\n        return color;\n      }\n      ${transition}\n      void main() {\n        gl_FragColor = transition(texCoords);\n      }\n    `;\n    return fragTemplate;\n  }\n}\n","import { noEffect } from './noEffect';\nimport { gray } from './gray';\nimport { Effect, EffectType } from '../../common/types/player';\nimport { ObjectType } from '../../common/types';\n\nconst effectMap: ObjectType<() => Effect> = {\n  [EffectType.NO_EFFECT]: noEffect,\n  [EffectType.GRAY]: gray,\n};\n\nexport default function effects(type?: EffectType) {\n  return effectMap[type || EffectType.NO_EFFECT]();\n}\n","export function noEffect() {\n  return {\n    uniforms: {},\n    fragment: (texName = 'tex', funName = 'effect') => `\n      vec4 ${funName}(vec2 uv) {\n        return texture2D(${texName}, uv);\n      }\n    `\n  };\n}","export function gray() {\n  return {\n    uniforms: {},\n    fragment: (texName = 'tex', funName = 'effect') => `\n      vec4 ${funName}(vec2 uv) {\n        vec4 color = texture2D(${texName}, uv);\n        float gray = (color.r+color.g+color.b)/3.;\n        return vec4(gray,gray,gray,color.a);\n      }\n    `\n  };\n}\n","/**\n * 视频不能通过设置currentTime实现播放\n * 存在视频已播完，但是下一个currentTime仍在有效范围内，会再次播放的bug\n */\nimport { ClipBase } from './base';\nimport { Shader } from '../painter/shader';\nimport effects from '../effects';\nimport * as THREE from 'three';\nimport { VideoClip } from '../../common/types/clip';\nimport { EffectType } from '../../common/types/player';\nimport { watch } from '../../common/utils';\n\nexport class Video extends ClipBase<VideoClip> {\n  private originEffect: EffectType = EffectType.NO_EFFECT;\n\n  private geometry?: THREE.PlaneGeometry;\n  private material?: THREE.ShaderMaterial;\n  private texture?: THREE.VideoTexture;\n  private video?: HTMLVideoElement;\n\n  async init() {\n    await this.initRender();\n    this.setPlaybackRate();\n    this.watchChange();\n  }\n\n  /**\n   * 监听属性变化\n   */\n  private watchChange() {\n    watch(this.config, 'start', () => {\n      this.player.renderFrame(true);\n    });\n    watch(this.config, 'end', () => {\n      this.player.renderFrame(true);\n    });\n  }\n\n  createTexture(): Promise<THREE.VideoTexture> {\n    return new Promise((resolve, reject) => {\n      this.video = document.createElement('video');\n      this.video.src = this.config.blobUrl;\n      this.video.loop = false;\n      this.video.autoplay = false;\n      this.video.addEventListener('loadeddata', async () => {\n        if (this.video) {\n          const texture = new THREE.VideoTexture(this.video);\n          resolve(texture);\n        }\n      });\n    });\n  }\n\n  async initRender() {\n    const { effect, fitType, width: videoWidth, height: videoHeight } = this.config;\n    const { player } = this;\n    const { uniforms, fragment } = effects(effect);\n    this.originEffect = effect;\n\n    this.texture = await this.createTexture();\n    this.geometry = new THREE.PlaneGeometry(player.width, player.height);\n    this.material = new THREE.ShaderMaterial({\n      uniforms: {\n        tex: { value: this.texture },\n        ratio: { value: player.width / player.height },\n        ...uniforms,\n      },\n      vertexShader: Shader.GetVertex(),\n      fragmentShader: Shader.GetEffectFragment({\n        clipRatio: videoWidth / videoHeight,\n        fitType: fitType,\n        effect: fragment(),\n      }),\n      // @ts-ignore\n      uniformsNeedUpdate: true,\n    });\n    this.material.transparent = true;\n    this.sprite = new THREE.Mesh(this.geometry, this.material);\n  }\n\n  getPlaybackRate() {\n    // duration 原始视频时长\n    const { start, end, durationInMs } = this.config;\n    const customDuration = end - start;\n    return durationInMs / customDuration;\n  }\n\n  setPlaybackRate() {\n    const video = this.video;\n    const newPlaybackRate = this.getPlaybackRate();\n    if (video && Math.abs(video.playbackRate - newPlaybackRate) >= 10e-6) {\n      video.playbackRate = newPlaybackRate;\n    }\n  }\n\n  play() {\n    const video = this.video;\n    if (video?.paused) {\n      video.play();\n    }\n  }\n\n  pause() {\n    super.pause();\n    const video = this.video;\n    if (video && !video.paused) {\n      video.pause();\n    }\n  }\n\n  show() {\n    if (this.sprite) {\n      this.sprite.visible = true;\n    }\n  }\n\n  hide() {\n    if (this.sprite) {\n      this.sprite.visible = false;\n    }\n  }\n\n  // 根据player的currentTime校正video的currentTime\n  async correctVideoCurrentTime() {\n    const { player: { currentTime } } = this;\n    const playbackRate = this.getPlaybackRate();\n    const newCurrentTime = (currentTime - this.config.start) * playbackRate / 1000;\n    // @ts-ignore\n    await this.texture.setCurrentTime(newCurrentTime);\n  }\n\n  async onCurrentTimeChange(isManual: boolean) {\n    if (this.player.isInRange(this)) { // 在有效的播放范围内\n      if (isManual) {\n        this.pause();\n        await this.correctVideoCurrentTime();\n      } else {\n        this.play();\n      }\n      this.isStart = true;\n      this.addToPainter();\n      this.render();\n    } else {\n      if (this.isStart) { // 上一帧在播放\n        this.isStart = false;\n        this.pause();\n      }\n      this.removeFromPainter();\n    }\n  }\n\n  updateShader() {\n    if (this.originEffect !== this.config.effect) { // 需要更新着色器\n      // console.log( 'update material');\n\n      // // generate shaders on-demand!\n      // let fs = new ShadersFragment(this._uniforms);\n      // let vs = new ShadersVertex();\n  \n      // this._material.vertexShader = vs.compute();\n      // this._material.fragmentShader = fs.compute();\n      // this._material.needsUpdate = true;\n    }\n  }\n\n  render() {\n    this.updateShader();\n    if (this.sprite) {\n      this.sprite.position.z = this.config.zIndex;\n    }\n  }\n\n  destroy() {\n    if (this.video) {\n      this.video = undefined;\n    }\n    if (this.texture) {\n      this.texture.dispose();\n    }\n    if (this.geometry) {\n      this.geometry.dispose();\n    }\n    if (this.material) {\n      this.material.dispose();\n    }\n  }\n}\n","import { ClipBase } from './base';\nimport { Shader } from '../painter/shader';\nimport effects from '../effects/index';\nimport { ImageClip } from '../../common/types/clip';\nimport * as THREE from 'three';\nimport { EffectType } from '../../common/types/player';\n\nexport class Image extends ClipBase<ImageClip> {\n  private originEffect: EffectType = EffectType.NO_EFFECT;\n  private geometry?: THREE.PlaneGeometry;\n  private material?: THREE.ShaderMaterial;\n  private texture?: THREE.Texture;\n\n  async init() {\n    await this.initRender();\n  }\n\n  createTexture(): Promise<THREE.Texture> {\n    return new Promise((resolve) => {\n      new THREE.TextureLoader().load(this.config.blobUrl, function(texture) {\n        resolve(texture);\n      });\n    });\n  }\n\n  async initRender() {\n    const { width: imageWidth, height: imageHeight, effect, fitType } = this.config;\n    const { player: { width, height } } = this;\n    const { uniforms, fragment } = effects(effect);\n    this.originEffect = effect;\n    this.texture = await this.createTexture();\n    this.geometry = new THREE.PlaneGeometry(width, height);\n    this.material = new THREE.ShaderMaterial({\n      uniforms: {\n        tex: { value: this.texture },\n        ratio: { value: width / height },\n        ...uniforms\n      },\n      vertexShader: Shader.GetVertex(),\n      fragmentShader: Shader.GetEffectFragment({\n        clipRatio: imageWidth / imageHeight,\n        fitType: fitType,\n        effect: fragment(),\n      }),\n      // @ts-ignore\n      uniformsNeedUpdate: true,\n    });\n    this.material.transparent = true;\n    this.sprite = new THREE.Mesh(this.geometry, this.material);\n  }\n\n  show() {\n    if (this.sprite) {\n      this.sprite.visible = true;\n    }\n  }\n\n  hide() {\n    if (this.sprite) {\n      this.sprite.visible = false;\n    }\n  }\n\n  onCurrentTimeChange() {\n    if (this.player.isInRange(this)) { // 在有效的播放范围内\n      this.addToPainter();\n      this.render();\n    } else {\n      this.removeFromPainter();\n    }\n  }\n\n  updateShader() {\n    if (this.originEffect !== this.config.effect) { // 需要更新着色器\n    }\n  }\n\n  render() {\n    this.updateShader();\n    if (this.sprite) {\n      this.sprite.position.z = this.config.zIndex;\n    }\n  }\n\n  destroy() {\n    if (this.texture) {\n      this.texture.dispose();\n    }\n    if (this.geometry) {\n      this.geometry.dispose();\n    }\n    if (this.material) {\n      this.material.dispose();\n    }\n  }\n}\n","import { TextClip } from '../../common/types/clip.js';\n// import Player from '../index';\nimport { ClipBase } from './base';\n\nexport class Text extends ClipBase<TextClip> {\n  // constructor(config: TextClip, player: Player) {\n  //   super(config, player);\n  // }\n\n  render() {}\n\n  destroy() {}\n}\n","// import Player from '..';\nimport { AudioClip } from '../../common/types/clip';\nimport { ClipBase } from './base';\n\nexport class Audio extends ClipBase<AudioClip> {\n  // constructor(config: AudioClip, player: Player) {\n  //   super(config, player);\n  // }\n\n  render() {\n    \n  }\n\n  destroy() {}\n}\n","import { morph } from './morph';\nimport { dreamy } from './dreamy';\nimport { fade } from './fade';\nimport { TransitionType } from '../../common/types/player';\n\nconst transitionMap = Object.freeze({\n  [TransitionType.MORPH]: morph,\n  [TransitionType.DREAMY]: dreamy,\n  [TransitionType.FADE]: fade\n});\n\nexport default function transitions(type: TransitionType) {\n  return transitionMap[type]();\n}\n","export function morph() {\n  return {\n    uniforms: {\n      strength: { value: 0.1 }\n    },\n    fragment: `\n      uniform float strength; // = 0.1\n      vec4 transition(vec2 p) {\n        vec4 ca = getFromColor(p);\n        vec4 cb = getToColor(p);\n        \n        vec2 oa = (((ca.rg+ca.b)*0.5)*2.0-1.0);\n        vec2 ob = (((cb.rg+cb.b)*0.5)*2.0-1.0);\n        vec2 oc = mix(oa,ob,0.5)*strength;\n        \n        float w0 = progress;\n        float w1 = 1.0-w0;\n        return mix(getFromColor(p+oc*w0), getToColor(p-oc*w1), progress);\n      }\n    `\n  };\n}\n","export function dreamy() {\n  return {\n    uniforms: {},\n    fragment: `\n      vec2 offset(float progress, float x, float theta) {\n        float phase = progress*progress + progress + theta;\n        float shifty = 0.03*progress*cos(10.0*(progress+x));\n        return vec2(0, shifty);\n      }\n      vec4 transition(vec2 p) {\n        return mix(getFromColor(p + offset(progress, p.x, 0.0)), getToColor(p + offset(1.0-progress, p.x, 3.14)), progress);\n      }\n    `\n  };\n}\n","export function fade() {\n  return {\n    uniforms: {},\n    fragment: `\n      vec4 transition(vec2 uv) {\n        return mix(\n          getFromColor(uv),\n          getToColor(uv),\n          progress\n        );\n      }\n    `\n  };\n}\n","/**\n * 连结两个视频或者图片\n * 两个视频都设置needRender为false，如果player的currentTime在第一个视频，则调用第一个视频的setCurrentTime，否则调用第二个的，如果是图片则不需要调用\n */\nimport { Shader } from '../painter/shader';\nimport effects from '../effects/index';\nimport transitions from '../transitions';\nimport { ClipBase } from './base';\nimport { TransitionClip } from '../../common/types/clip';\nimport Player from '..';\nimport * as THREE from 'three';\n\nexport class Transition extends ClipBase<TransitionClip> {\n  private geometry?: THREE.PlaneGeometry;\n  private material?: THREE.ShaderMaterial;\n\n  constructor(config: TransitionClip, player: Player) {\n    super(config, player);\n    Promise.resolve().then(() => {\n      this.config.from = this.player.getClipById(this.config.fromId);\n      this.config.to = this.player.getClipById(this.config.toId);\n      this.initRender();\n    });\n  }\n\n  // 由于不知道关联视频或者图片的初始状态，所以需要等到渲染的时候再初始化\n  initRender() {\n    const { player } = this;\n    const { fromId, toId, transition } = this.config;\n    const { width, height } = player;\n    const fromClip = player.getClipById(fromId);\n    const toClip = player.getClipById(toId);\n    if (fromClip && toClip) {\n      const {\n        width: fromWidth, \n        height: fromHeight,\n        effect: fromEffect,\n        texture: fromTexture,\n        fitType: fromFitType\n      } = fromClip.config;\n      const {\n        width: toWidth, \n        height: toHeight,\n        effect: toEffect,\n        texture: toTexture,\n        fitType: toFitType\n      } = toClip.config;\n      const { uniforms: fromUniforms, fragment: fromFragment } = effects(fromEffect);\n      const { uniforms: toUniforms, fragment: toFragment } = effects(toEffect);\n      const { uniforms: transitionUniforms, fragment: transitionFragment } = transitions(transition);\n      this.geometry = new THREE.PlaneGeometry(width, height);\n      this.material = new THREE.ShaderMaterial({\n        uniforms: {\n          from: { value: fromTexture },\n          to: { value: toTexture },\n          progress: { value: 0 },\n          ratio: { value: width / height },\n          ...fromUniforms,\n          ...toUniforms,\n          ...transitionUniforms,\n        },\n        vertexShader: Shader.GetVertex(),\n        fragmentShader: Shader.GetTransitionFragment({\n          fromFitType,\n          fromEffect: fromFragment('from', 'fromEffect'),\n          fromRatio: fromWidth / fromHeight,\n          toFitType,\n          toEffect: toFragment('to', 'toEffect'),\n          toRatio: toWidth / toHeight,\n          transition: transitionFragment,\n        }),\n        // @ts-ignore\n        uniformsNeedUpdate: true,\n      });\n      this.material.transparent = true;\n      this.sprite = new THREE.Mesh(this.geometry, this.material);\n    }\n  }\n\n  onCurrentTimeChange() {\n    if (this.player.isInRange(this)) { // 在有效的播放范围内\n      this.addToPainter();\n      // this.from.hide();\n      // this.to.hide();\n      this.render();\n    } else {\n      this.removeFromPainter();\n      // this.from.show();\n      // this.to.show();\n    }\n  }\n\n  render() {\n    const { start, end, from: fromClip } = this.config;\n    const progress = (this.player.currentTime - start) / (end - start);\n    if (this.sprite && this.material?.uniforms && fromClip) {\n      this.sprite.position.z = fromClip.config.zIndex + 1;\n      this.material.uniforms.progress.value = progress;\n    }\n  }\n\n  destroy() {}\n }","import { SvgClip } from '../../common/types/clip';\nimport Player from '../index';\nimport { ClipBase } from './base';\nimport * as THREE from 'three';\nimport { svgToCanvas } from '../../common/utils';\n\nexport class Svg extends ClipBase<SvgClip> {\n  private canvas: HTMLCanvasElement = document.createElement('canvas');\n  private context: CanvasRenderingContext2D | null | undefined;\n\n  private geometry: THREE.PlaneGeometry | undefined;\n  private material: THREE.MeshBasicMaterial | undefined;\n\n  constructor(config: SvgClip, player: Player) {\n    super(config, player);\n    this.initCanvas();\n    this.initRender();\n  }\n\n  initCanvas() {\n    const { player: { width, height } } = this;\n    this.canvas.width = width;\n    this.canvas.height = height;\n    this.context = this.canvas.getContext('2d');\n  }\n\n  initRender() {\n    const { player: { width, height } } = this;\n    this.geometry = new THREE.PlaneGeometry(width, height);\n    this.material = new THREE.MeshBasicMaterial();\n    this.material.map = new THREE.CanvasTexture(this.canvas);\n    this.material.transparent = true;\n    this.sprite = new THREE.Mesh(this.geometry, this.material);\n  }\n\n  async onCurrentTimeChange() {\n    if (this.player.isInRange(this)) { // 在有效的播放范围内\n      this.addToPainter();\n      await this.render();\n    } else {\n      this.removeFromPainter();\n    }\n  }\n\n  async render() {\n    if (this.material?.map && this.sprite) {\n      const { start, end } = this.config;\n      const { player: { width, height, currentTime } } = this;\n      const svg = this.config.func({ start, end, currentTime, width, height });\n      await svgToCanvas(svg, this.canvas, this.context);\n      this.material.map.needsUpdate = true;\n      this.sprite.position.z = this.config.zIndex;\n    }\n  }\n\n  destroy() {}\n}\n","import * as THREE from 'three';\n\nexport default class Painter {\n  private scene: THREE.Scene;\n  private camera: THREE.Camera;\n  private renderer: THREE.WebGLRenderer;\n  private maxAnisotropy: number;\n\n  constructor(width: number, height: number) {\n    this.scene = new THREE.Scene();\n    this.camera = new THREE.OrthographicCamera(width / - 2, width / 2, height / 2, height / - 2, -1000, 1000);\n    this.renderer = new THREE.WebGLRenderer({ \n      preserveDrawingBuffer: true,\n      antialias: true\n    });\n    this.renderer.setPixelRatio(2);\n    this.renderer.setSize(width, height);\n    this.maxAnisotropy = this.renderer.capabilities.getMaxAnisotropy();\n  }\n\n  add(sprite: THREE.Mesh, name: string) {\n    sprite.name = name;\n    this.scene.add(sprite);\n  }\n\n  remove(name: string) {\n    const selectedObject = this.scene.getObjectByName(name);\n    if (selectedObject) {\n      this.scene.remove(selectedObject);\n    }\n  }\n\n  getDomElement() {\n    return this.renderer.domElement;\n  }\n\n  render() {\n    const {renderer, scene, camera} = this;\n    renderer.render(scene, camera);\n  }\n}\n","import { ClipBase } from './base';\nimport * as THREE from 'three';\nimport { LottieClip } from '../../common/types/clip';\nimport Player from '..';\n\nexport class Lottie extends ClipBase<LottieClip> {\n  private geometry: THREE.PlaneGeometry | undefined;\n  private material: THREE.MeshBasicMaterial | undefined;\n\n  constructor(config: LottieClip, player: Player) {\n    super(config, player);\n    this.initRender();\n  }\n\n  initRender() {\n    const { player: { width, height } } = this;\n    this.geometry = new THREE.PlaneGeometry(width, height);\n    this.material = new THREE.MeshBasicMaterial();\n    const texture = new THREE.CanvasTexture(document.createElement('canvas'));\n    // texture.animation = this.config.lottie;\n    // texture.image = this.config.lottie.container;\n    this.material.map = texture;\n    this.material.transparent = true;\n    this.sprite = new THREE.Mesh(this.geometry, this.material);\n  }\n\n  async onCurrentTimeChange() {\n    if (this.player.isInRange(this)) { // 在有效的播放范围内\n      this.addToPainter();\n      this.render();\n    } else {\n      this.removeFromPainter();\n    }\n  }\n\n  async render() {\n    if (this.sprite && this.material?.map) {\n      const { player: { currentTime } } = this;\n      this.config.lottie.goToAndStop(currentTime - this.config.start);\n      this.material.map.needsUpdate = true;\n      this.sprite.position.z = this.config.zIndex;\n    }\n  }\n\n  destroy() {}\n}","import { Video } from './clips/video';\nimport { Image } from './clips/image';\nimport { Text } from './clips/text';\nimport { Audio } from './clips/audio';\nimport { Transition } from './clips/transition';\nimport { Svg } from './clips/svg';\nimport Painter from './painter';\nimport { Lottie } from './clips/lottie';\nimport {\n  AudioClip,\n  Clip,\n  ClipType,\n  ImageClip,\n  LottieClip,\n  SvgClip,\n  TextClip,\n  TransitionClip,\n  VideoClip,\n} from '../common/types/clip';\nimport { ClipBase } from './clips/base';\n\nfunction createElement(config: Clip, player: Player) {\n  switch (config.type) {\n    case ClipType.VIDEO:\n      return new Video(config as VideoClip, player);\n    case ClipType.IMAGE:\n      return new Image(config as ImageClip, player);\n    case ClipType.TRANSITION:\n      return new Transition(config as TransitionClip, player);\n    case ClipType.TEXT:\n      return new Text(config as TextClip, player);\n    case ClipType.AUDIO:\n      return new Audio(config as AudioClip, player);\n    case ClipType.SVG:\n      return new Svg(config as SvgClip, player);\n    case ClipType.LOTTIE:\n      return new Lottie(config as LottieClip, player);\n  }\n}\n\n/**\n * 需要知道element在上一帧是否播放，才能精准调用pause，也就是要知道element的start和end事件，并且只调用一次\n * 视频或者音频只要在有效范围内都正常播放，转场只是隐藏sprite(不渲染)\n */\n\ntype Props = {\n  tracks: Clip[][];\n  width: number;\n  height: number;\n  onCurrentTimeChange?(currentTime: number): void;\n  onEnd?(): void;\n};\n\nexport default class Player {\n  // 自动播放相关\n  private tickTime = -1; // 用于启动自动播放\n  private tickReq = 0;\n\n  public painter: Painter;\n  public currentTime = 0;\n  public duration = 0;\n  public clips: ClipBase<Clip>[] = [];\n  public playing = false;\n  public width = 0;\n  public height = 0;\n  \n  private tickFun;\n\n  public onCurrentTimeChange?: (currentTime: number) => void;\n  public onEnd?: () => void;\n\n  constructor({ tracks, width, height, onCurrentTimeChange, onEnd }: Props) {\n    this.width = width;\n    this.height = height;\n    this.painter = new Painter(width, height);\n    this.tickFun = this.tick.bind(this);\n    this.clips = (tracks || []).flat(1).map((clip) => {\n      return createElement(clip, this) as ClipBase<Clip>;\n    });\n    this.updateDuration();\n    this.onCurrentTimeChange = onCurrentTimeChange;\n    this.onEnd = onEnd;\n  }\n\n  updateDuration() {\n    this.duration = 0;\n    this.clips.forEach(({ config }) => {\n      if (config.end > this.duration) {\n        this.duration = config.end;\n      }\n    });\n  }\n\n  isInRange(clip: ClipBase<Clip>) {\n    const { start, end } = clip.config;\n    return start <= this.currentTime && end >= this.currentTime;\n  }\n\n  getClipById(id?: string) {\n    return this.clips.find((clip) => clip.config.id === id);\n  }\n\n  async addClip(clip: Clip) {\n    const newClip = createElement(clip, this) as ClipBase<Clip>;\n    await newClip.init();\n    this.clips.push(newClip);\n    this.updateDuration();\n    this.pause();\n  }\n\n  removeClip(id?: string) {\n    const clip = this.getClipById(id);\n    if (clip) {\n      clip.destroy();\n      clip.removeFromPainter();\n      this.clips.splice(this.clips.indexOf(clip), 1);\n      // 删除关联的转场 TODO:\n      // if ([ClipType.VIDEO, ClipType.IMAGE].includes(clip.type)) {\n      //   for (let i = 0; i < this.clips.length; i++) {\n      //     if (\n      //       this.clips[i].type === ClipType.TRANSITION &&\n      //       [this.clips[i].fromId, this.clips[i].toId].includes(clip.id)\n      //     ) {\n      //       this.clips.splice(i, 1);\n      //     }\n      //   }\n      // }\n      this.updateDuration();\n      this.pause();\n    }\n  }\n\n  async play() {\n    if (!this.playing) {\n      this.playing = true;\n      this.tickReq = requestAnimationFrame(this.tickFun);\n    }\n    await this.renderFrame(false);\n    this.tickTime = performance.now();\n  }\n\n  async tick(time: number) {\n    const interval = Math.ceil(time - this.tickTime);\n    if (this.currentTime + interval >= this.duration) {\n      this.currentTime = this.duration;\n      await this.renderFrame(false);\n      this.pause();\n      this.onEnd?.();\n    } else {\n      this.currentTime += interval;\n      await this.renderFrame(false);\n      this.tickTime = time;\n      this.tickReq = requestAnimationFrame(this.tickFun);\n    }\n  }\n\n  pause() {\n    this.tickTime = -1;\n    this.playing = false;\n    cancelAnimationFrame(this.tickReq);\n    this.clips.forEach((clip) => {\n      clip.pause();\n    });\n  }\n\n  // 点击进度条调用此方法\n  async setCurrentTime(currentTime: number) {\n    this.pause();\n    this.currentTime = currentTime;\n    await this.renderFrame(true);\n  }\n\n  // 渲染对应currentTime的帧\n  async renderFrame(isManual: boolean) {\n    const clips = this.clips;\n    const len = this.clips.length;\n    for (let i = 0; i < len; i++) {\n      await clips[i].onCurrentTimeChange(isManual);\n    }\n    this.painter.render();\n    this.onCurrentTimeChange?.(this.currentTime);\n  }\n\n  destroy() {\n    this.clips.forEach((clip) => {\n      clip.destroy();\n    });\n    this.clips.length = 0;\n    this.clips = [];\n  }\n\n  attachTo(element: HTMLElement) {\n    element.appendChild(this.painter.getDomElement());\n  }\n}\n","import React, { useCallback, useEffect, useRef, useState } from 'react';\nimport Stage from './components/Stage';\nimport SideBar from './components/SideBar';\nimport Tracks from './components/Tracks';\nimport {\n  StyledEditor,\n  StyledEditorLeft,\n  StyledEditorRight,\n  StyledStageTimeline,\n  StyledTimelineWrapper,\n} from './styled';\nimport { EditorContext } from './type';\nimport { Clip } from '../common/types/clip';\nimport Ruler from './components/Ruler';\nimport { getTotalDuration, millisecondsToWidth } from './util';\nimport { useKeyboard } from './hooks/keyboard';\nimport { INIT_EDITOR_CONTEXT } from './config';\nimport { usePlayer } from './hooks/player';\n\nexport const editorContext = React.createContext<EditorContext>(INIT_EDITOR_CONTEXT);\n\nconst Editor: React.FC = () => {\n  const [hoverTrack, setHoverTrack] = useState<HTMLElement | null>(null);\n  const [tracks, setTracks] = useState<Clip[][]>([[]]);\n  const [newTrackIndex, setNewTrackIndex] = useState(-1);\n  const [totalDuration, setTotalDuration] = useState(0);\n  const [activeClipId, setActiveClipId] = useState('');\n  const [currentTime, setCurrentTime] = useState(0);\n  const playerContainerRef = useRef<HTMLDivElement>(null);\n\n  const handleTracksChange = useCallback((tracks: Clip[][]) => {\n    const newTracks = tracks.filter((track) => track.length);\n    const newTotalDuration = getTotalDuration(newTracks);\n    if (newTotalDuration !== totalDuration) {\n      setTotalDuration(newTotalDuration);\n      if (currentTime > newTotalDuration) {\n        setCurrentTime(newTotalDuration);\n      }\n    }\n    // 更新zIndex\n    newTracks.flat(1).forEach((clip, index) => {\n      clip.zIndex = index;\n    });\n    setTracks(newTracks.length ? newTracks : [[]]);\n  }, [currentTime, totalDuration]);\n\n  useEffect(() => {\n    // 更新容器的宽度\n    if (totalDuration) {\n      const scrollContainer = document.querySelector('.tracks-wrapper') as HTMLElement;\n      if (scrollContainer) {\n        const currentWidth = scrollContainer.clientWidth;\n        const newWidth = millisecondsToWidth(totalDuration);\n        if (currentWidth < newWidth) {\n          scrollContainer.style.width = `${newWidth + 100}px`;\n        }\n      }\n    }\n  }, [totalDuration]);\n\n  const editorContextValue = {\n    hoverTrack,\n    setHoverTrack,\n    tracks,\n    setTracks: handleTracksChange,\n    newTrackIndex,\n    setNewTrackIndex,\n    activeClipId,\n    setActiveClipId,\n    currentTime,\n    setCurrentTime,\n    totalDuration,\n    setTotalDuration,\n  };\n\n  // 绑定键盘操作\n  useKeyboard(editorContextValue);\n\n  const { playing, setPlaying } = usePlayer(editorContextValue, playerContainerRef);\n  const handlePlayingChange = useCallback(() => {\n    setPlaying(!playing);\n  }, [playing, setPlaying]);\n\n  return (\n    <editorContext.Provider value={editorContextValue}>\n      <StyledEditor>\n        <StyledEditorLeft>\n          <SideBar />\n        </StyledEditorLeft>\n        <StyledEditorRight>\n          <StyledStageTimeline>\n            <div style={{ display: 'flex', justifyContent: 'space-evenly' }}>\n              <Stage />\n              <div ref={playerContainerRef} style={{ width: 720, height: 480 }}></div>\n              <div onClick={handlePlayingChange}>\n                { playing ? '暂停' : '播放' }\n              </div>\n            </div>\n            <StyledTimelineWrapper>\n              <div>Toolbar</div>\n              <Ruler />\n              <Tracks />\n            </StyledTimelineWrapper>\n          </StyledStageTimeline>\n        </StyledEditorRight>\n      </StyledEditor>\n    </editorContext.Provider>\n  );\n};\n\nexport default Editor;\n","import React, { useEffect, useRef, useState } from 'react';\nimport { Clip } from '../../common/types/clip';\nimport Player from '../../player';\nimport { ClipBase } from '../../player/clips/base';\nimport { EditorContext } from '../type';\n\n// 找出tracks出现了哪些改变\nconst findDiff = (playerData: ClipBase[], newData: Clip[][]) => {\n  const newClips: Clip[] = [];\n  const deleteClips: string[] = [];\n  const flatNewData = newData.flat(1);\n  playerData.forEach((instance) => {\n    const newClip = flatNewData.find((clip) => clip.id === instance.config.id);\n    if (!newClip && instance.config.id) { // 表示删除\n      deleteClips.push(instance.config.id);\n    }\n  });\n  flatNewData.forEach((clip, index) => {\n    const oldClip = playerData.find((item) => item.config.id === clip.id);\n    if (!oldClip) {\n      newClips.push(clip);\n    }\n  });\n  return {\n    newClips,\n    deleteClips,\n  };\n}\n\n\nexport const usePlayer = (\n  editorContextValue: EditorContext,\n  containerRef: React.RefObject<HTMLDivElement>,\n) => {\n  const player = useRef<Player>();\n  const { tracks, setCurrentTime, currentTime, totalDuration } = editorContextValue;\n  const [playing, setPlaying] = useState<boolean>(false);\n\n  /**\n   * 初始化播放器\n   */\n  useEffect(() => {\n    if (!player.current && containerRef.current) {\n      player.current = new Player({\n        tracks,\n        width: 720,\n        height: 480,\n        onCurrentTimeChange: (currentTime: number) => {\n          setCurrentTime(currentTime);\n        },\n        onEnd: () => {\n          setPlaying(false);\n        },\n      });\n      player.current.attachTo(containerRef.current);\n    }\n  }, [containerRef, setCurrentTime, tracks]);\n\n  /**\n   * 增删\n   */\n  useEffect(() => {\n    if (player.current && tracks.length) {\n      const { newClips, deleteClips } = findDiff(player.current.clips, tracks);\n      newClips.forEach(async (clip) => {\n        await player.current?.addClip(clip);\n        player.current?.renderFrame(true);\n      });\n      if (deleteClips.length) {\n        deleteClips.forEach((id) => {\n          player.current?.removeClip(id);\n        });\n        player.current?.renderFrame(true);\n      }\n    }\n  }, [tracks]);\n\n  /**\n   * 暂停/播放\n   */\n  useEffect(() => {\n    if (player.current) {\n      if (playing) {\n        player.current.play();\n      } else {\n        player.current.pause();\n      }\n    }\n  }, [playing]);\n\n  /**\n   * 定位改变\n   */\n  useEffect(() => {\n    if (player.current && currentTime >= 0 && !playing) {\n      player.current.setCurrentTime(currentTime);\n    }\n  }, [currentTime, playing]);\n\n  /**\n   * 更新总时长\n   */\n  useEffect(() => {\n    if (player.current && totalDuration >= 0) {\n      player.current.updateDuration();\n    }\n  }, [totalDuration]);\n\n  return { player: player.current, playing, setPlaying };\n};\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport Editor from './editor';\nimport './index.css';\n\nReactDOM.render(\n  <React.StrictMode>\n    <Editor />\n  </React.StrictMode>,\n  document.getElementById('root')\n);\n","module.exports = THREE;"],"sourceRoot":""}